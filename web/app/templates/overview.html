<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/css/overview.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="/static/js/scripts.js"></script>
     <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <title>Overview</title>
</head>

<body>
    <nav>
        <a class="active">Computer Science CMU</a>
        <ul class="menu">
            <li class="list">
                <a href="javascript:void(0);" onclick="ShowPopupMenu();"><i class="bi bi-list"></i></a>
                <ul class="popup-menu" id="popupMenu">
                    <li><a href="/overview">ภาพรวม/Overview</a></li>
                    <li><a href="/subject_credit">ภาพรวมหลักสูตร/Subjects</a></li>
                    <li><button class="Logout" type="button"><a href="/user/signout_student" class="btn btn-secondary">Sign Out</a></button></li>
                </ul>
            </li>
        </ul>
    </nav>
    <div class="info">
        <p class="text">
            <span class="span">ชื่อ - นามสกุล / Name - Surname: {{ session['user']['first_name'] }} {{ session['user']['last_name'] }}</span><br>
            <span class="span">รหัสนักศึกษา / Student ID: {{ session['user']['_id'] }}</span><br>
            <span id="tea" class="span">อาจารย์ที่ปรึกษา / Advisor:</span>
        </p>
    </div>
    <!-- link ไฟล์ excel ยังทำไม่ได้ -->
    <div class="temp"><span id="dowlod" onclick="downloadFile()">Download excel template</span></div> 
    <div class="plans">แผนการศึกษา: {{ session['user']['study_plan'] }}</div>


    
    <input type="file" id="fileInput" style="display: none;">
    <button class="Bplan" id="uploadButton" name="choose" type="button" onclick="chooseFile()">Upload</button>


    <div id="GPAA" class="gpa">Cumulative GPA :</div>
    <!-- จะทำเป็น link กดไป folder ในคอม แต่ทำไม่ได้ -->
    <div class="impex">Import ข้อมูลการลงทะเบียนโดย excel</div> 
    <div class="study">Overview
        <div class="y1">Year 1
            <div id="loop"class="board">
                
            </div>
            <button id="myBtn1" class="edit" type="button">เพิ่ม</button>
            <button id="myBtn" class="edit" type="button">ลบ</button>
            
        </div>
        <div class="y2">Year 2
            <div id="loop2"class="board">
                
            </div>
            
        </div>
        <div class="y3">Year 3
            <div id="loop3"class="board">
                
            </div>
            <!-- <button class="edit" type="button">Edit</button> -->
        </div>
        <div class="y4">Year 4
            <div id ="loop4"class="board">
                
            </div>
            <!-- <button class="edit" type="button">Edit</button> -->
        </div>
    </div>


    <div id="myModal" class="modal">
    <!-- Modal content -->
        <div class="modal-content">
        <span class="close ttt">&times;</span>
        <div class="ids">รหัสวิชา</div>
        <form method="post">
            <input type="text" name="subj" class="id">
            <input class="Add" id="myBtn" type="submit" value="ลบ">
        </form> 
        </div>
    </div>

    <div id="myModal1" class="modal">
    <!-- Modal content -->
        <div class="modal-content">
        <span class="close ttt1">&times;</span>
        
        <form method="post" action="/form2">
            <div class="t">
                <input type="text" name="subj" class="" placeholder="subject">
                <input type="text" name="grade" class="" placeholder="grade">
                <input type="text" name="year" class="" placeholder="year">
                <input type="text" name="credit" class="" placeholder="credit">
                <input class="" id="myBtn" type="submit" value="เพิ่ม">
            </div>
        </form> 
        </div>
    </div>
    <script>   
        var modal = document.getElementById("myModal");
        var modal1 = document.getElementById("myModal1");

        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        var btn1 = document.getElementById("myBtn1");
        

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("ttt")[0];
        var span1 = document.getElementsByClassName("ttt1")[0];

        // When the user clicks the button, open the modal
        btn.onclick = function () {
        modal.style.display = "block";
        }
        btn1.onclick = function () {
        modal1.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
        modal.style.display = "none";
        }
        span1.onclick = function () {
        modal1.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        }
        window.onclick = function (event) {
        if (event.target == modal1) {
            modal1.style.display = "none";
        }
        }
    function downloadFile() {
        // นี่คือส่วนของโค้ดที่คุณสามารถใช้ในการดาวน์โหลดไฟล์ Excel
        // ในที่นี้จะแสดงตัวอย่างโค้ดเปิดหน้าต่างดาวน์โหลดไฟล์
        var downloadLink = document.createElement('a');
        downloadLink.href = '/static/form.xlsx'; // URL ของไฟล์ Excel
        downloadLink.download = 'form.xlsx'; // ชื่อไฟล์ที่จะดาวน์โหลด
        downloadLink.click();
    }

    function chooseFile() {
        document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').addEventListener('change', function() {
        var selectedFile = this.files[0];
        if (selectedFile) {
            // ทำสิ่งที่คุณต้องการกับไฟล์ที่ถูกเลือกที่นี่
            console.log('ได้รับไฟล์: ' + selectedFile.name);

            // สามารถทำการอัพโหลดไฟล์ไปยังเซิร์ฟเวอร์ที่ต้องการที่นี่
            // เช่น การใช้ Fetch API หรือ XMLHttpRequest
            // โดยให้ตรวจสอบเอกสารและโค้ดของเซิร์ฟเวอร์ของคุณสำหรับรายละเอียดเพิ่มเติม
        }
    });


        const hoverText = document.getElementById("dowlod");

        hoverText.onmouseover = function() {
            hoverText.style.color = "gray"; // Change text color on hover
            hoverText.style.cursor = "pointer";
        };

        hoverText.onmouseout = function() {
            hoverText.style.color = "black"; // Reset text color when mouse leaves
            hoverText.style.cursor = "default";
        };
        
    

        







        console.log("*******")
        
        console.log("*******")
        function displayData(data){
            console.log(data[0]["subject_id"]);
            console.log(data[0]);
            console.log(data.length)
            console.log("TTTTTTTTTTTTTT")
            
            var container = document.getElementById("loop");
            var html = '';
            var j = 0;
            for(var i = 0; i < data.length; i++){
                j++;
                var num;
                if(data[i]["grade"] == "4"){
                    num = "A"
                }
                if(data[i]["grade"] == "3.5"){
                    num = "B+"
                }
                if(data[i]["grade"] == "3"){
                    num = "B"
                }
                if(data[i]["grade"] == "2.5"){
                    num = "C+"
                }
                if(data[i]["grade"] == "2"){
                    num = "C"
                }
                if(data[i]["grade"] == "1.5"){
                    num = "D+"
                }
                if(data[i]["grade"] == "1"){
                    num = "D"
                }
                if(data[i]["grade"] == "0"){
                    num = "F"
                }
                
                html+= `<div class='sid'><span class="left-content">${data[i]["subject_id"]}</span><span class="middle-content">Grade:</span><span class="right-content">${num}</span></div>`; 
            }
            for(var k = 0; k <16- j; k++){
                html+= `<div class='sid'><span class="left-content">&nbsp;</span><span class="middle-content">&nbsp;</span><span class="right-content">&nbsp;</span></div>`; 

            }
            container.innerHTML = html;
            return 2;
        }
        function displayData2(data){
            console.log(data[0]);
            console.log(data.length)
            
            var container = document.getElementById("loop2");
            var html = '';
            
            var j = 0;
            for(var i = 0; i < data.length; i++){
                j++;
                var num;
                if(data[i]["grade"] == "4"){
                    num = "A"
                }
                if(data[i]["grade"] == "3.5"){
                    num = "B+"
                }
                if(data[i]["grade"] == "3"){
                    num = "B"
                }
                if(data[i]["grade"] == "2.5"){
                    num = "C+"
                }
                if(data[i]["grade"] == "2"){
                    num = "C"
                }
                if(data[i]["grade"] == "1.5"){
                    num = "D+"
                }
                if(data[i]["grade"] == "1"){
                    num = "D"
                }
                if(data[i]["grade"] == "0"){
                    num = "F"
                }
                
                html+= `<div class='sid'><span class="left-content">${data[i]["subject_id"]}</span><span class="middle-content">Grade:</span><span class="right-content">${num}</span></div>`; 
            }
            for(var k = 0; k <16- j; k++){
                html+= `<div class='sid'><span class="left-content">&nbsp;</span><span class="middle-content">&nbsp;</span><span class="right-content">&nbsp;</span></div>`; 

            }
            container.innerHTML = html;
            return 3;
            
        }
        function displayData3(data){
            console.log(data[0]);
            console.log(data.length)
            
            var container = document.getElementById("loop3");
            var html = '';

            var j = 0;
            for(var i = 0; i < data.length; i++){
                j++;
                var num;
                if(data[i]["grade"] == "4"){
                    num = "A"
                }
                if(data[i]["grade"] == "3.5"){
                    num = "B+"
                }
                if(data[i]["grade"] == "3"){
                    num = "B"
                }
                if(data[i]["grade"] == "2.5"){
                    num = "C+"
                }
                if(data[i]["grade"] == "2"){
                    num = "C"
                }
                if(data[i]["grade"] == "1.5"){
                    num = "D+"
                }
                if(data[i]["grade"] == "1"){
                    num = "D"
                }
                if(data[i]["grade"] == "0"){
                    num = "F"
                }
                
                html+= `<div class='sid'><span class="left-content">${data[i]["subject_id"]}</span><span class="middle-content">Grade:</span><span class="right-content">${num}</span></div>`; 
            }
            for(var k = 0; k <16- j; k++){
                html+= `<div class='sid'><span class="left-content">&nbsp;</span><span class="middle-content">&nbsp;</span><span class="right-content">&nbsp;</span></div>`; 

            }
            container.innerHTML = html;
        }
        function displayData4(data){
            console.log(data[0]);
            console.log(data.length)
            
            var container = document.getElementById("loop4");
            var html = '';

            var j = 0;
            for(var i = 0; i < data.length; i++){
                j++;
                var num;
                if(data[i]["grade"] == "4"){
                    num = "A"
                }
                if(data[i]["grade"] == "3.5"){
                    num = "B+"
                }
                if(data[i]["grade"] == "3"){
                    num = "B"
                }
                if(data[i]["grade"] == "2.5"){
                    num = "C+"
                }
                if(data[i]["grade"] == "2"){
                    num = "C"
                }
                if(data[i]["grade"] == "1.5"){
                    num = "D+"
                }
                if(data[i]["grade"] == "1"){
                    num = "D"
                }
                if(data[i]["grade"] == "0"){
                    num = "F"
                }
                
                html+= `<div class='sid'><span class="left-content">${data[i]["subject_id"]}</span><span class="middle-content">Grade:</span><span class="right-content">${num}</span></div>`; 
            }
            for(var k = 0; k <16- j; k++){
                html+= `<div class='sid'><span class="left-content">&nbsp;</span><span class="middle-content">&nbsp;</span><span class="right-content">&nbsp;</span></div>`; 

            }
            container.innerHTML = html;
        }
        function showteacher(data){
            
            var a= data[0]["first_name"];
            var b= data[0]["last_name"];
            console.log(a);
            var html = '';
            var container = document.getElementById("tea");
            html += `อาจารย์ที่ปรึกษา / Advisor: ${a} ${b}`;
            container.innerHTML = html;

        }
        function showgrade(data){
            console.log("11111111111");
            var a = data[0]["Grade"];
            console.log(typeof(a));
            console.log("11111111111");
            var container = document.getElementById("GPAA");
            var html = a.toFixed(3);
            var gpaa = a.toFixed(3);
            var tgpa = Math.round(gpaa * 100) / 100;
            container.innerHTML = `Cumulative GPA : ${tgpa.toFixed(2)}`;

        }
        $(document).ready(function () {
            $.getJSON("/data1", function (data) {
                // Call the displayData function to update the HTML with the received data
                displayData(data);
            });
            $.getJSON("/data2", function (data) {
                // Call the displayData function to update the HTML with the received data
                displayData2(data);
            });
            $.getJSON("/data3", function (data) {
                // Call the displayData function to update the HTML with the received data
                displayData3(data);
            });
            $.getJSON("/data4", function (data) {
                // Call the displayData function to update the HTML with the received data
                displayData4(data);
            });
            $.getJSON("/tadvisee", function (data) {
                // Call the displayData function to update the HTML with the received data
                showteacher(data);
            });
            $.getJSON("/avggrade", function (data) {
                // Call the displayData function to update the HTML with the received data
                showgrade(data);
            });
        });

        function ShowPopupMenu() {
            let popupMenu = document.getElementById('popupMenu');

            if (popupMenu.style.display === 'none') {
                popupMenu.style.display = 'block';
            } else {
                popupMenu.style.display = 'none';
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script>
        function chooseFile() {
          // เรียกใช้งาน input ที่ซ่อนไว้
          const fileInput = document.getElementById('fileInput');
          
          // กำหนดคอนฟิกเลือกสำหรับ input เป็นไฟล์ Excel
          fileInput.accept = '.xlsx, .xls';
          
          // เมื่อไฟล์ถูกเลือก
          fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            // ตรวจสอบว่ามีไฟล์ที่ถูกเลือก
            if (file) {
              const reader = new FileReader();
              
              // เมื่ออ่านไฟล์เสร็จสิ้น
              reader.onload = function(event) {
                const data = event.target.result;
                
                // ใช้ SheetJS เพื่อแปลง Excel เป็น JSON
                const workbook = XLSX.read(data, { type: 'binary' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // jsonData จะมีข้อมูล JSON จาก Excel
                console.log('jsonData  ===> ', jsonData);
                // enroll_all = {}
                //---------------แปลงให้อยู่รูปแบบที่ถูกสำหรับจัดเก็บ-----------
                var yyy
                const transformedData = jsonData.map(item => {
                    const subject_id = item.__EMPTY_1.toString();
                    const grade = parseFloat(item.__EMPTY_2);
                    
                    if (item.__EMPTY_5){
                        yyy = item.__EMPTY_5
                        console.log('ssss')
                    }
                    const year = item.__EMPTY_5 || yyy; // ถ้าไม่มีข้อมูลปีกำหนดให้เป็น 1
                    const credit = parseFloat(item.__EMPTY_3);
                    return { subject_id, grade, year, credit };
                });

                const enroll_add = { enroll: transformedData }; 

                enroll_add_all = enroll_add['enroll']
                // ลบ row แรก 
                if (Array.isArray(enroll_add_all) && enroll_add_all.length > 0) {
                for (let i = 0; i < enroll_add_all.length; i++) {
                    if (isNaN(enroll_add_all[i].credit)) {
                    enroll_add_all.splice(i, 1); // ลบอ็อบเจ็กต์ที่มี credit เป็น NaN ออกจากอาร์เรย์
                    i--; // เพื่อป้องกันการข้ามอ็อบเจ็กต์หลังจากการลบ
                    }
                }
                } else {
                console.error("enroll_add is not an array or is empty");
                }




                console.log('enroll_add_all ==> ', enroll_add_all) 
                console.log('enroll_add_all ==> ', typeof(enroll_add_all)) 
                // console.log('enroll_add ==> ', Object.keys(enroll_add).length) 
                // console.log('enroll_add ==> ', Object.keys(enroll_add)) 


               
              };
              
              // อ่านไฟล์เป็น binary
              reader.readAsBinaryString(file);
            }
          });
          
          // เปิดหน้าต่างเลือกไฟล์
          fileInput.click();
        }

        
    </script>
</body>

</html>